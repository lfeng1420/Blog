<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="baidu-site-verification" content="L6Lm9d5Crl"/>
  
  
  
  
  <title>ZooKeeper服务框架介绍 | lfeng</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="描述ZooKeeper（简称ZK）是一个开源的分布式协调服务，其设计目标是将那些复杂且容易出错的分布式一致性服务封装起来，构成一个高效可靠的原语集，并以一系列简单易用的接口提供给用户使用。原语： 操作系统或计算机网络用语范畴，由若干条指令组成，用于完成一定功能的一个过程，具有不可分割性，即原语的执行必须是连续的，在执行过程中不允许被中断。">
<meta name="keywords" content="ZooKeeper,Framework,Cluster">
<meta property="og:type" content="article">
<meta property="og:title" content="ZooKeeper服务框架介绍">
<meta property="og:url" content="https://blog.lfengs.com/2019/ZooKeeper-Intro.html">
<meta property="og:site_name" content="lfeng">
<meta property="og:description" content="描述ZooKeeper（简称ZK）是一个开源的分布式协调服务，其设计目标是将那些复杂且容易出错的分布式一致性服务封装起来，构成一个高效可靠的原语集，并以一系列简单易用的接口提供给用户使用。原语： 操作系统或计算机网络用语范畴，由若干条指令组成，用于完成一定功能的一个过程，具有不可分割性，即原语的执行必须是连续的，在执行过程中不允许被中断。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://blog.lfengs.com/images/2019/ZooKeeper-Intro/zknamespace.jpg">
<meta property="og:image" content="https://blog.lfengs.com/images/2019/ZooKeeper-Intro/zkservice.jpg">
<meta property="og:image" content="https://blog.lfengs.com/images/2019/ZooKeeper-Intro/start-route.png">
<meta property="og:image" content="https://blog.lfengs.com/images/2019/ZooKeeper-Intro/server-join.png">
<meta property="og:image" content="https://blog.lfengs.com/images/2019/ZooKeeper-Intro/consistency.png">
<meta property="og:image" content="https://blog.lfengs.com/images/2019/ZooKeeper-Intro/cluster-tree.png">
<meta property="og:image" content="https://blog.lfengs.com/images/2019/ZooKeeper-Intro/distributed-lock.png">
<meta property="og:updated_time" content="2019-07-11T16:09:27.336Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ZooKeeper服务框架介绍">
<meta name="twitter:description" content="描述ZooKeeper（简称ZK）是一个开源的分布式协调服务，其设计目标是将那些复杂且容易出错的分布式一致性服务封装起来，构成一个高效可靠的原语集，并以一系列简单易用的接口提供给用户使用。原语： 操作系统或计算机网络用语范畴，由若干条指令组成，用于完成一定功能的一个过程，具有不可分割性，即原语的执行必须是连续的，在执行过程中不允许被中断。">
<meta name="twitter:image" content="https://blog.lfengs.com/images/2019/ZooKeeper-Intro/zknamespace.jpg">
  
    <link rel="alternative" href="/atom.xml" title="lfeng" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.ico">
  
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet" />
  <script>
      var yiliaConfig = {
          fancybox: true,
          animate: false,
          isHome: false,
          isPost: true,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: true
      }
  </script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        
<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>

        <a href="/" class="profilepic">
            
            <img src="/img/avatar.jpg" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
            
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">lfeng</a></h1>
        </hgroup>
        
        
            <form>
                <input type="text" class="st-default-search-input search" id="local-search-input" placeholder="搜索一下" autocomplete="off">
            </form>
            <div id="local-search-result"></div>
        
        
            <script type="text/javascript">
                (function() {
                    'use strict';
                    function getMatchData(keyword, data) {
                        var matchData = [];
                        for(var i =0;i<data.length;i++){
                            if(data[i].title.toLowerCase().indexOf(keyword)>=0) 
                                matchData.push(data[i])
                        }
                        return matchData;
                    }
                    var $input = $('#local-search-input');
                    var $resultContent = $('#local-search-result');
                    $input.keyup(function(){
                        $.ajax({
                            url: '/search.json',
                            dataType: "json",
                            success: function( json ) {
                                var str='<ul class=\"search-result-list\">';                
                                var keyword = $input.val().trim().toLowerCase();
                                $resultContent.innerHTML = "";
                                if ($input.val().trim().length <= 0) {
                                    $resultContent.empty();
                                    $('#switch-area').show();
                                    return;
                                }
                                var results = getMatchData(keyword, json);
                                if(results.length === 0){
                                    $resultContent.empty();
                                    $('#switch-area').show();
                                    return;
                                } 
                                for(var i =0; i<results.length; i++){
                                    str += "<li><a href='"+ results[i].url +"' class='search-result-title'>"+ results[i].title +"</a></li>";
                                }
                                str += "</ul>";
                                $resultContent.empty();
                                $resultContent.append(str);
                                $('#switch-area').hide();
                            }
                        });
                    });
                })();
            </script>
        
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
					<img src="/img/menu.png" style="width: 100%;height: 100%;opacity: 1;">
                    <!-- <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div> -->
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        
        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a  href="/">主页</a></li>
                        
                            <li><a  href="/about">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl github"  target="_blank" href="https://github.com/lfeng1420" title="github">github</a>
                            
                                <a class="fl weibo"  target="_blank" href="https://weibo.com/lfeng1420" title="weibo">weibo</a>
                            
                                <a class="fl rss"  target="_blank" href="/atom.xml" title="rss">rss</a>
                            
                        </ul>
                    </nav>
                </section>
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/Cluster/" style="font-size: 10px;">Cluster</a> <a href="/tags/FSM/" style="font-size: 10px;">FSM</a> <a href="/tags/Framework/" style="font-size: 10px;">Framework</a> <a href="/tags/Game-AI/" style="font-size: 10px;">Game-AI</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/RenameTool/" style="font-size: 10px;">RenameTool</a> <a href="/tags/Test/" style="font-size: 10px;">Test</a> <a href="/tags/Trigger/" style="font-size: 13.33px;">Trigger</a> <a href="/tags/Visual-Studio/" style="font-size: 10px;">Visual Studio</a> <a href="/tags/Windows/" style="font-size: 16.67px;">Windows</a> <a href="/tags/ZooKeeper/" style="font-size: 10px;">ZooKeeper</a> <a href="/tags/behaviac/" style="font-size: 10px;">behaviac</a> <a href="/tags/blog/" style="font-size: 10px;">blog</a> <a href="/tags/cmd/" style="font-size: 10px;">cmd</a> <a href="/tags/cocos2dx/" style="font-size: 20px;">cocos2dx</a> <a href="/tags/crash/" style="font-size: 10px;">crash</a> <a href="/tags/curl/" style="font-size: 10px;">curl</a> <a href="/tags/dump/" style="font-size: 10px;">dump</a> <a href="/tags/eclipse/" style="font-size: 10px;">eclipse</a> <a href="/tags/github/" style="font-size: 10px;">github</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/https/" style="font-size: 10px;">https</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/master-slave/" style="font-size: 10px;">master-slave</a> <a href="/tags/msg-queue/" style="font-size: 10px;">msg-queue</a> <a href="/tags/mstsc/" style="font-size: 10px;">mstsc</a> <a href="/tags/openssl/" style="font-size: 10px;">openssl</a> <a href="/tags/php/" style="font-size: 10px;">php</a> <a href="/tags/protobuf/" style="font-size: 10px;">protobuf</a> <a href="/tags/rabbitmq/" style="font-size: 10px;">rabbitmq</a> <a href="/tags/replication/" style="font-size: 10px;">replication</a> <a href="/tags/svn/" style="font-size: 10px;">svn</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a> <a href="/tags/windbg/" style="font-size: 10px;">windbg</a> <a href="/tags/wininet/" style="font-size: 10px;">wininet</a>
                    </div>
                </section>
                
                
                
                
                <section class="switch-part switch-part3">
                
                    <div id="js-aboutme">lalalala</div>
                </section>
                
            </div>
        </div>
    </header>
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">lfeng</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img src="/img/avatar.jpg" class="js-avatar" style="width: 100%; height: 100%; opacity: 1;">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">lfeng</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/about">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="github" target="_blank" href="https://github.com/lfeng1420" title="github">github</a>
                    
                        <a class="weibo" target="_blank" href="https://weibo.com/lfeng1420" title="weibo">weibo</a>
                    
                        <a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
                    
                </div>
            </nav>
        </header>
    </div>
</nav>
      <div class="body-wrap"><article id="post-ZooKeeper-Intro" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a  href="/2019/ZooKeeper-Intro.html" class="article-date">
      <time datetime="2019-07-11T15:09:22.000Z" itemprop="datePublished">2019-07-11</time>
</a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      ZooKeeper服务框架介绍
    </h1>
  


      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Framework/">Framework</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Cluster/">Cluster</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Framework/">Framework</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ZooKeeper/">ZooKeeper</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h2><p><code>ZooKeeper</code>（简称ZK）是一个开源的分布式协调服务，其设计目标是将那些复杂且容易出错的分布式一致性服务封装起来，构成一个高效可靠的<strong>原语集</strong>，并以一系列简单易用的接口提供给用户使用。<br><strong>原语： 操作系统或计算机网络用语范畴，由若干条指令组成，用于完成一定功能的一个过程，具有不可分割性，即原语的执行必须是连续的，在执行过程中不允许被中断。</strong><br><a id="more"></a></p>
<h3 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h3><ul>
<li><strong>顺序一致性</strong>：客户端发起的更新会按发送顺序被应用到ZK上；</li>
<li><strong>原子性</strong>：更新操作要么成功要么失败，不会出现中间状态；</li>
<li><strong>单一视图</strong>：无论客户端连接的是哪个服务器，其看到的服务视图（树型结构）都是一致的；</li>
<li><strong>可靠性</strong>：一个更新操作一旦被接受即不会意外丢失，除非被其它更新操作覆盖；</li>
<li><strong>实时性</strong>：在一定时间（不能保证立即）内，客户端能获取到最新的数据。</li>
</ul>
<h2 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h2><p>ZK提供一个多层级的节点（<code>ZNode</code>）命名空间，类似于文件系统。命名就是一系列用<code>/</code>分割的路径元素，每一个ZK节点的命名空间都是用路径进行标识的。与文件系统不同的是，这些节点都可以设置关联数据，而文件系统中只有文件节点可以存放数据而目录节点不能。<br>ZK为了保证高吞吐和低延迟，在内存中维护了这个树状的目录结构，这种特性使得ZK不能用于存放大量的数据，每个节点的存放数据上限为1M。<br>ZK保证读写都是原子操作，且每次读写操作都是对数据的完整读取或完整写入，并不提供对数据进行部分读取或者写入的操作。</p>
<p><img src="../images/2019/ZooKeeper-Intro/zknamespace.jpg" alt=""></p>
<h3 id="节点类型"><a href="#节点类型" class="headerlink" title="节点类型"></a>节点类型</h3><p>节点类型有以下三大类：<br>持久节点（<code>PERSISTENT</code>）：持久节点是指在节点创建后，就一直存在，不会因为创建该节点的客户端会话失效而消失，直到有删除操作来主动清除这个节点。<br>临时节点（<code>EPHEMERAL</code>）：在客户端会话结束后自动删除，利用临时节点的这一特性，我们可以使用临时节点来进行集群管理，包括发现服务的上下线等。<br>顺序节点（<code>SEQUENTIAL</code>）：创建时自动在指定路径之后添加<code>%10d</code>格式的序号，这个序号可以保证在同一个父节点下是唯一的。<br>通过组合可以生成如下四种类型节点：<br>持久节点（<code>PERSISTENT</code>）、持久顺序节点（<code>PERSISTENT_SEQUENTIAL</code>）、临时节点（<code>EPEMERAL</code>）和临时顺序节点（<code>EPEMERAL_SEQUENTIAL</code>）。<br>需要注意临时节点不能创建子节点。</p>
<h3 id="节点属性"><a href="#节点属性" class="headerlink" title="节点属性"></a>节点属性</h3><ul>
<li><code>dataVersion</code>：数据版本号，每次对节点进行set操作，<code>dataVersion</code>的值都会增加1（即使设置的是相同的数据）。</li>
<li><code>cversion</code>：子节点的版本号。当节点下的子节点有变化时，<code>cversion</code>的值就会增加1。</li>
<li><code>aclVersion</code>：<code>ACL</code>（<code>Access Control List</code>，访问控制）的版本号。</li>
<li><code>cZxid</code>：创建的事务id。</li>
<li><code>mZxid</code>：被修改的事务id，即每次对节点的修改都会更新<code>mZxid</code>。</li>
<li><code>ctime</code>：创建的时间戳。</li>
<li><code>mtime</code>：修改的时间戳。</li>
<li><code>dataLength</code>：数据长度。</li>
<li><code>numChildren</code>：子节点数量。</li>
<li><code>ephemeralOwner</code>：如果节点是临时节点，则这是节点所有者的<code>session ID</code>；如果不是临时节点，则该字段为零。</li>
</ul>
<p>ZK状态的每一次改变，都对应着一个递增的<code>Transaction id</code>，该id称为<code>zxid</code>。实现中<code>zxid</code>是一个64位数值，高32位是集群选举周期<code>epoch</code>，每次选出新的<code>Leader</code>，<code>epoch</code>加1。低32位为该周期内的序号，每次周期值变化，都将低32位的序号重置。创建任意节点，或者更新任意节点的数据，或者删除任意节点，都会导致ZK状态发生改变，从而导致<code>zxid</code>的值增加。</p>
<p>示例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 4] get -s /key1</span><br><span class="line">werw2342</span><br><span class="line">cZxid = 0x10000000d</span><br><span class="line">ctime = Wed Jul 03 15:39:20 CST 2019</span><br><span class="line">mZxid = 0x10000000d</span><br><span class="line">mtime = Wed Jul 03 15:39:20 CST 2019</span><br><span class="line">pZxid = 0x10000000d</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x300157916070000</span><br><span class="line">dataLength = 8</span><br><span class="line">numChildren = 0</span><br></pre></td></tr></table></figure></p>
<h3 id="事件监听器（Watch）"><a href="#事件监听器（Watch）" class="headerlink" title="事件监听器（Watch）"></a>事件监听器（<code>Watch</code>）</h3><p>事件监听器是ZK中的一个很重要的特性。ZK允许用户在指定节点上注册一些监听器，并且在一些特定事件触发的时候，ZK服务器会将事件通知给感兴趣的客户端，该机制是ZK实现分布式协调服务的重要特性。<br>事件监听器具有如下特点：</p>
<ul>
<li><strong>主动推送</strong>：`事件监听器被触发时，由ZK服务器主动将更新推送给客户端，而不需要客户端轮询。</li>
<li><strong>一次性</strong>：数据变化时，监听器只会被触发一次。如果客户端想得到后续更新的通知，必须要在监听器被触发后重新注册一个事件监听器。</li>
<li><strong>可见性</strong>：如果一个客户端在读请求中附带事件监听器，事件监听器被触发的同时再次读取数据，客户端在得到监听器消息之前肯定不可能看到更新后的数据。换句话说，更新通知先于更新结果。</li>
<li><strong>顺序性</strong>：如果多个更新触发了多个事件监听器，那事件监听器被触发的顺序与更新顺序一致。</li>
</ul>
<h3 id="访问控制（ACL）"><a href="#访问控制（ACL）" class="headerlink" title="访问控制（ACL）"></a>访问控制（<code>ACL</code>）</h3><p><code>ACL</code>的实现方式非常类似于<code>UNIX</code>文件的访问权限：它采用访问权限位允许或禁止对节点的各种操作以及能进行操作的范围。不同于<code>UNIX</code>权限的是，ZK的节点不局限于用户（文件的拥有者），组和其他人（其它）这三个标准范围。ZK不具有节点的拥有者的概念，相反，ACL指定id集以及与之对应的权限。需要注意<code>ACL</code>仅针对于一个特定的节点，没有递归机制。<br><code>ACL</code>使用<code>schema:id:permission</code>标识，各个部分意义如下：</p>
<ul>
<li><code>schema</code>：方案，可使用<code>world</code>/<code>ip</code>/<code>auth</code>/<code>digest</code>；</li>
<li><code>id</code>：授权对象ID，即权限赋予的对象或实体，例如：IP地址或用户名密码；</li>
<li><code>permission</code>：权限，包含<code>CREATE</code>/<code>DELETE</code>/<code>READ</code>/<code>WRITE</code>/<code>ADMIN</code>，简写为<code>c/d/r/w/a</code>，其中<code>ADMIN</code>表示可设置节点<code>ACL</code>权限。</li>
</ul>
<p><strong>示例：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># world</span></span><br><span class="line"><span class="comment"># 格式：setAcl &lt;path&gt; world:anyone:&lt;acl&gt;</span></span><br><span class="line"><span class="comment"># 设置所有人拥有全部权限，默认情况，注意world下只有anyone</span></span><br><span class="line">setAcl /key1 world:anyone:cdrwa</span><br><span class="line"></span><br><span class="line"><span class="comment"># ip</span></span><br><span class="line"><span class="comment"># 格式：setAcl &lt;path&gt; ip:&lt;ip&gt;:&lt;acl&gt;</span></span><br><span class="line"><span class="comment"># &lt;ip&gt;可以是具体IP也可以是IP/bit格式，即IP转换为二进制，匹配前bit位</span></span><br><span class="line"><span class="comment"># 设置前缀为192.168的IP拥有除了设置ACL权限之外的其他权限</span></span><br><span class="line">setAcl /key1 ip:192.168.0.0/16:cdrw</span><br><span class="line"></span><br><span class="line"><span class="comment"># auth</span></span><br><span class="line"><span class="comment"># 添加认证用户：addauth digest &lt;user&gt;:&lt;password&gt;</span></span><br><span class="line"><span class="comment"># 格式：setAcl &lt;path&gt; auth:&lt;user&gt;:&lt;acl&gt;</span></span><br><span class="line">addauth digest testuser:testuser</span><br><span class="line">setAcl /key1 auth:testuser:cdrwa</span><br><span class="line"></span><br><span class="line"><span class="comment"># digest</span></span><br><span class="line"><span class="comment"># 格式：setAcl &lt;path&gt; digest:&lt;user&gt;:&lt;password&gt;:&lt;acl&gt;</span></span><br><span class="line"><span class="comment"># &lt;password&gt;为经过SHA1及BASE64处理的密文（BASE64(SHA1(password))）</span></span><br></pre></td></tr></table></figure>
<h2 id="服务器集群"><a href="#服务器集群" class="headerlink" title="服务器集群"></a>服务器集群</h2><p><img src="../images/2019/ZooKeeper-Intro/zkservice.jpg" alt=""></p>
<h3 id="角色"><a href="#角色" class="headerlink" title="角色"></a>角色</h3><ul>
<li><code>Leader</code>：负责发起并维护与各<code>Follwer</code>及<code>Observer</code>间的心跳以及主导所有写操作的执行流程。所有的写操作必须要通过<code>Leader</code>完成再由<code>Leader</code>将写操作广播给其它服务器（包括自己在内）。</li>
<li><code>Follower</code>：可直接处理并返回客户端的读请求，同时将写请求转发给<code>Leader</code>处理，并且负责在<code>Leader</code>处理写请求时对请求进行投票。</li>
<li><code>Observer</code>：角色与<code>Follower</code>类似，但是无投票权。目的是扩展系统，提高读取速度。</li>
<li><code>Learner</code>：<code>Follower</code>/<code>Observer</code>。</li>
<li><code>Client</code>：请求发起方。</li>
</ul>
<h3 id="原子消息广播协议（Zookeeper-Atomic-Broadcast）"><a href="#原子消息广播协议（Zookeeper-Atomic-Broadcast）" class="headerlink" title="原子消息广播协议（Zookeeper Atomic Broadcast）"></a>原子消息广播协议（<code>Zookeeper Atomic Broadcast</code>）</h3><p>为了保证写操作的一致性与可用性，ZK设计了一种名为原子广播的支持崩溃恢复的一致性协议。基于该协议，ZK实现了一种主从模式的系统架构来保持集群中各个副本之间的数据一致性。<br>根据ZAB协议，所有的写操作都必须通过<code>Leader</code>完成，<code>Leader</code>写入日志后再复制到所有的<code>Follower</code>节点。一旦<code>Leader</code>节点无法工作，ZAB协议能够自动从<code>Follower</code>中重新选出一个合适的替代者，即新的<code>Leader</code>，该过程被称为领导选举。</p>
<h3 id="服务器状态"><a href="#服务器状态" class="headerlink" title="服务器状态"></a>服务器状态</h3><ul>
<li><code>LOOKING</code>：不确定<code>Leader</code>状态。该状态下的服务器认为当前集群中没有<code>Leader</code>，会发起<code>Leader</code>选举；</li>
<li><code>FOLLOWING</code>：跟随者状态。表明当前服务器角色是<code>Follower</code>，并且它知道<code>Leader</code>是谁；</li>
<li><code>LEADING</code>：领导者状态。表明当前服务器角色是<code>Leader</code>，它会维护与<code>Follower</code>间的心跳；</li>
<li><code>OBSERVING</code>：观察者状态。表明当前服务器角色是<code>Observer</code>，与<code>Folower</code>唯一的不同在于不参与选举，也不参与集群写操作时的投票。</li>
</ul>
<h3 id="会话"><a href="#会话" class="headerlink" title="会话"></a>会话</h3><p>会话指的是ZK服务器与客户端会话。在ZK中，一个客户端连接是指客户端和服务器之间的一个<code>TCP</code>长连接。客户端启动的时候，首先会与服务器建立一个<code>TCP</code>连接，从第一次连接建立开始，客户端会话的生命周期也开始了。通过这个连接，客户端能够通过心跳检测与服务器保持有效的会话，也能够向ZK服务器发送请求并接受响应，同时还能够通过该连接接收来自服务器的<code>Watch</code>事件通知。<br>在为客户端创建会话之前，服务端首先会为每个客户端都分配一个<code>SessionID</code>。<code>SessionID</code>是ZK会话的一个重要标识，许多与会话相关的运行机制都是基于这个<code>SessionID</code>的，因此，无论是哪台服务器为客户端分配的<code>SessionID</code>，都务必保证全局唯一。</p>
<h3 id="读写操作"><a href="#读写操作" class="headerlink" title="读写操作"></a>读写操作</h3><h4 id="读操作"><a href="#读操作" class="headerlink" title="读操作"></a>读操作</h4><p><code>Leader</code>/<code>Follower</code>/<code>Observer</code>都可直接处理读数据请求（从内存中读取数据）。</p>
<h4 id="写操作"><a href="#写操作" class="headerlink" title="写操作"></a>写操作</h4><ul>
<li>客户端连接非<code>Leader</code>服务器进行写操作时，服务器转发消息交给<code>Leader</code>服务器处理；</li>
<li><code>Leader</code>服务器收到写操作请求时，将其转换为一个提议（<code>Proposal</code>），分发给集群内所有<code>Follwer</code>，之后等待各个<code>Follwer</code>的回复（<code>ACK</code>）；</li>
<li><code>Follower</code>收到提议时，记录事务日志，待日志记录完成后给<code>Leader</code>发送<code>ACK</code>；</li>
<li><code>Leader</code>收到超过半数（n/2+1，<code>Leader</code>自己有一个）的回复后，向所有<code>Follower</code>和<code>Observer</code>发送提交（<code>Commit</code>）消息；</li>
<li><code>Leader</code>回复操作结果。</li>
</ul>
<h3 id="领导选举"><a href="#领导选举" class="headerlink" title="领导选举"></a>领导选举</h3><h4 id="投票数据结构"><a href="#投票数据结构" class="headerlink" title="投票数据结构"></a>投票数据结构</h4><p>每个服务器在进行<code>Leader</code>选举时，会发送如下关键信息<br><code>leader</code>：被推举的服务器的<code>sid</code>；<br><code>zxid</code>：被推举的服务器上所保存的数据的最大<code>zxid</code>；<br><code>electionEpoch</code>：当前服务器的<code>epoch</code>（逻辑时钟），用来判断多个投票是否在同一轮选举周期中，每进行新一轮的投票后，都会对该值加1；<br><code>peerEpoch</code>：被推举的服务器的<code>epoch</code>；<br><code>state</code>：投票所属服务器的状态；<br><code>sid</code>：当前服务器的<code>sid</code>。</p>
<h4 id="投票流程"><a href="#投票流程" class="headerlink" title="投票流程"></a>投票流程</h4><p><strong>1、自增选举轮次</strong><br>ZK规定所有有效的投票都必须在同一轮次中。每个服务器在开始新一轮投票时，会先对自己维护的<code>electionEpoch</code>进行自增操作。</p>
<p><strong>2、初始化投票</strong><br>每个服务器在广播自己的投票前，会将自己的投票记录表清空。该记录表记录了收到的投票。例：服务器2投票给服务器3，服务器3投票给服务器1，则服务器1的投票记录表为<code>(2, 3), (3, 1)</code>。记录表中只会记录每一投票者的最后一票，如投票者更新自己的投票，则其它服务器收到该新投票后会在自己的投票记录表中更新该服务器的投票。</p>
<p><strong>3、发送初始化投票</strong><br>每个服务器最开始都是把票投给自己并广播投票消息给其他服务器。</p>
<p><strong>4、接收并处理外部投票</strong><br>收到外部投票后，首先会根据投票信息中所包含的<code>epoch</code>来进行不同处理：</p>
<ul>
<li>外部投票的<code>epoch</code>大于自己的<code>epoch</code>，说明服务器的选举轮次落后于其它服务器的选举轮次，此时立即清空自己的投票记录表并将自己的<code>epoch</code>更新为收到的<code>epoch</code>，之后再对比自己之前的投票与收到的投票确定是否需要变更自己的投票（投票PK），最终再次将自己的投票广播出去；</li>
<li>外部投票的<code>epoch</code>小于自己的<code>epoch</code>，当前服务器直接忽略该投票；</li>
<li>外部投票的<code>epoch</code>与自己的相等，此时进行投票PK。</li>
</ul>
<p><strong>5、投票PK</strong><br>投票PK是基于<code>(zxid,leader)</code>的对比：</p>
<ul>
<li>外部<code>zxid</code>大于自己的<code>zxid</code>，变更自己的投票信息为<code>(zxid,leader)</code>并广播，另外将收到的票及自己更新后的票放入自己的投票记录表；</li>
<li><code>zxid</code>相等，外部<code>leader</code>大于自己的<code>leader</code>，变更自己的投票信息为<code>(zxid,leader)</code>并广播，另外将收到的票及自己更新后的票放入自己的投票记录表；</li>
<li>其他情况，不做任何变更。</li>
</ul>
<p><strong>6、统计投票</strong><br>如果已经确定有过半服务器认可了自己的投票（可能是更新后的投票），则终止投票。否则继续接收其它服务器的投票。如果超过了指定时间没有收到足够的投票，则</p>
<p><strong>7、更新服务器状态</strong><br>投票终止后，服务器开始更新自身状态。若过半的票投给了自己，则将自己的服务器状态更新为<code>LEADING</code>，否则将自己的状态更新为<code>FOLLOWING</code>。</p>
<h3 id="领导选举场景"><a href="#领导选举场景" class="headerlink" title="领导选举场景"></a>领导选举场景</h3><h4 id="启动时"><a href="#启动时" class="headerlink" title="启动时"></a>启动时</h4><p>以三台服务器为例，流程如下图所示（由于初始情况下<code>epoch</code>都为1，<code>zxid</code>都为0，因此省略）：<br><img src="../images/2019/ZooKeeper-Intro/start-route.png" alt=""></p>
<p>1、初始时，每台服务器都处于<code>LOOKING</code>状态，都投票给自己并广播给其他服务器；<br>2、服务器1收到2和3发来的投票，由于ID的大小关系，最终会清空投票列表并更新自己的投票为服务器3并广播给其他服务器；服务器2收到1和3发来的投票，同理，最终只保留服务器3的投票，以及更新自己的投票为服务器3并广播给其他服务器；服务器3收到1和2发来的投票，由于都比自己的ID小，因此不会做任何处理；<br>3、服务器2收到1发来的投票，放入自己的投票列表；服务器3收到1和2发来的投票，放入自己的投票列表。此时三个服务器的投票列表相同，因此最终服务器3成为<code>Leader</code>，服务器1和2成为<code>Follower</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># server 1（`round`对应自己的`epoch`）</span></span><br><span class="line">2019-07-08 11:13:37,882 [myid:1] - INFO  [QuorumPeer[myid=1](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled):QuorumPeer@1193] - LOOKING</span><br><span class="line">2019-07-08 11:13:37,883 [myid:1] - INFO  [QuorumPeer[myid=1](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled):FastLeaderElection@885] - New election. My id =  1, proposed zxid=0x0</span><br><span class="line">2019-07-08 11:13:39,397 [myid:1] - INFO  [WorkerReceiver[myid=1]:FastLeaderElection@679] - Notification: 2 (message format version), 1 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 1 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:13:39,398 [myid:1] - WARN  [RecvWorker:3:QuorumCnxManager<span class="variable">$RecvWorker</span>@1176] - Connection broken <span class="keyword">for</span> id 3, my id = 1, error = </span><br><span class="line">java.io.EOFException</span><br><span class="line">	at java.io.DataInputStream.readInt(DataInputStream.java:392)</span><br><span class="line">2019-07-08 11:13:39,398 [myid:1] - WARN  [RecvWorker:3:QuorumCnxManager<span class="variable">$RecvWorker</span>@1179] - Interrupting SendWorker</span><br><span class="line">2019-07-08 11:13:39,398 [myid:1] - WARN  [SendWorker:3:QuorumCnxManager<span class="variable">$SendWorker</span>@1092] - Interrupted <span class="keyword">while</span> waiting <span class="keyword">for</span> message on queue</span><br><span class="line">java.lang.InterruptedException</span><br><span class="line">	at java.util.concurrent.locks.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span>.reportInterruptAfterWait(AbstractQueuedSynchronizer.java:2014)</span><br><span class="line">2019-07-08 11:13:40,401 [myid:1] - INFO  [WorkerReceiver[myid=1]:FastLeaderElection@679] - Notification: 2 (message format version), 2 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 2 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:13:40,402 [myid:1] - INFO  [WorkerReceiver[myid=1]:FastLeaderElection@679] - Notification: 2 (message format version), 3 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 3 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:13:40,402 [myid:1] - INFO  [WorkerReceiver[myid=1]:FastLeaderElection@679] - Notification: 2 (message format version), 2 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 2 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:13:40,403 [myid:1] - INFO  [WorkerReceiver[myid=1]:FastLeaderElection@679] - Notification: 2 (message format version), 3 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 3 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:13:41,412 [myid:1] - INFO  [WorkerReceiver[myid=1]:FastLeaderElection@679] - Notification: 2 (message format version), 2 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 1 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:13:42,424 [myid:1] - INFO  [WorkerReceiver[myid=1]:FastLeaderElection@679] - Notification: 2 (message format version), 2 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 2 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:13:42,425 [myid:1] - INFO  [WorkerReceiver[myid=1]:FastLeaderElection@679] - Notification: 2 (message format version), 3 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 1 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:13:42,425 [myid:1] - INFO  [WorkerReceiver[myid=1]:FastLeaderElection@679] - Notification: 2 (message format version), 3 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 2 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:13:42,626 [myid:1] - INFO  [QuorumPeer[myid=1](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled):QuorumPeer@1269] - FOLLOWING</span><br><span class="line"></span><br><span class="line"><span class="comment"># server 2</span></span><br><span class="line">2019-07-08 11:13:38,469 [myid:2] - INFO  [QuorumPeer[myid=2](plain=/0:0:0:0:0:0:0:0:2182)(secure=disabled):QuorumPeer@1193] - LOOKING</span><br><span class="line">2019-07-08 11:13:38,470 [myid:2] - INFO  [QuorumPeer[myid=2](plain=/0:0:0:0:0:0:0:0:2182)(secure=disabled):FastLeaderElection@885] - New election. My id =  2, proposed zxid=0x0</span><br><span class="line">2019-07-08 11:13:39,518 [myid:2] - INFO  [WorkerReceiver[myid=2]:FastLeaderElection@679] - Notification: 2 (message format version), 2 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 2 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:13:39,518 [myid:2] - INFO  [QuorumPeer[myid=2](plain=/0:0:0:0:0:0:0:0:2182)(secure=disabled):FastLeaderElection@919] - Notification time out: 400</span><br><span class="line">2019-07-08 11:13:39,518 [myid:2] - INFO  [WorkerReceiver[myid=2]:FastLeaderElection@679] - Notification: 2 (message format version), 1 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 1 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:13:39,519 [myid:2] - INFO  [localhost/127.0.0.1:2382:QuorumCnxManager<span class="variable">$Listener</span>@888] - Received connection request /127.0.0.1:53745</span><br><span class="line">2019-07-08 11:13:40,142 [myid:2] - WARN  [RecvWorker:3:QuorumCnxManager<span class="variable">$RecvWorker</span>@1176] - Connection broken <span class="keyword">for</span> id 3, my id = 2, error = </span><br><span class="line">java.io.EOFException</span><br><span class="line">	at java.io.DataInputStream.readInt(DataInputStream.java:392)</span><br><span class="line">2019-07-08 11:13:40,521 [myid:2] - INFO  [WorkerReceiver[myid=2]:FastLeaderElection@679] - Notification: 2 (message format version), 1 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 1 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:13:40,522 [myid:2] - INFO  [WorkerSender[myid=2]:QuorumCnxManager@430] - Have smaller server identifier, so dropping the connection: (3, 2)</span><br><span class="line">2019-07-08 11:13:41,142 [myid:2] - INFO  [localhost/127.0.0.1:2382:QuorumCnxManager<span class="variable">$Listener</span>@888] - Received connection request /127.0.0.1:53755</span><br><span class="line">2019-07-08 11:13:41,143 [myid:2] - WARN  [RecvWorker:3:QuorumCnxManager<span class="variable">$RecvWorker</span>@1176] - Connection broken <span class="keyword">for</span> id 3, my id = 2, error = </span><br><span class="line">java.io.EOFException</span><br><span class="line">	at java.io.DataInputStream.readInt(DataInputStream.java:392)</span><br><span class="line">2019-07-08 11:13:41,523 [myid:2] - INFO  [WorkerReceiver[myid=2]:FastLeaderElection@679] - Notification: 2 (message format version), 3 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 3 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:13:41,524 [myid:2] - INFO  [WorkerReceiver[myid=2]:FastLeaderElection@679] - Notification: 2 (message format version), 3 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 3 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:13:42,524 [myid:2] - INFO  [WorkerReceiver[myid=2]:FastLeaderElection@679] - Notification: 2 (message format version), 2 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 1 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:13:42,525 [myid:2] - INFO  [WorkerReceiver[myid=2]:FastLeaderElection@679] - Notification: 2 (message format version), 2 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 2 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:13:42,525 [myid:2] - INFO  [WorkerReceiver[myid=2]:FastLeaderElection@679] - Notification: 2 (message format version), 3 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 3 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:13:42,525 [myid:2] - INFO  [WorkerReceiver[myid=2]:FastLeaderElection@679] - Notification: 2 (message format version), 3 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 3 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:13:42,526 [myid:2] - INFO  [WorkerReceiver[myid=2]:FastLeaderElection@679] - Notification: 2 (message format version), 3 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 1 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:13:42,526 [myid:2] - INFO  [WorkerReceiver[myid=2]:FastLeaderElection@679] - Notification: 2 (message format version), 3 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 2 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:13:42,727 [myid:2] - INFO  [QuorumPeer[myid=2](plain=/0:0:0:0:0:0:0:0:2182)(secure=disabled):QuorumPeer@1269] - FOLLOWING</span><br><span class="line"></span><br><span class="line"><span class="comment"># server 3</span></span><br><span class="line">2019-07-08 11:13:39,122 [myid:3] - INFO  [QuorumPeer[myid=3](plain=/0:0:0:0:0:0:0:0:2183)(secure=disabled):QuorumPeer@1193] - LOOKING</span><br><span class="line">2019-07-08 11:13:39,123 [myid:3] - INFO  [QuorumPeer[myid=3](plain=/0:0:0:0:0:0:0:0:2183)(secure=disabled):FastLeaderElection@885] - New election. My id =  3, proposed zxid=0x0</span><br><span class="line">2019-07-08 11:13:40,140 [myid:3] - INFO  [WorkerReceiver[myid=3]:FastLeaderElection@679] - Notification: 2 (message format version), 1 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 1 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:13:40,141 [myid:3] - INFO  [WorkerReceiver[myid=3]:FastLeaderElection@679] - Notification: 2 (message format version), 3 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 3 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:13:41,142 [myid:3] - INFO  [WorkerReceiver[myid=3]:FastLeaderElection@679] - Notification: 2 (message format version), 2 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 2 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:13:41,142 [myid:3] - INFO  [WorkerReceiver[myid=3]:FastLeaderElection@679] - Notification: 2 (message format version), 3 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 3 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:13:41,142 [myid:3] - INFO  [WorkerReceiver[myid=3]:FastLeaderElection@679] - Notification: 2 (message format version), 1 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 1 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:13:41,143 [myid:3] - INFO  [WorkerReceiver[myid=3]:FastLeaderElection@679] - Notification: 2 (message format version), 2 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 1 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:13:41,143 [myid:3] - INFO  [localhost/127.0.0.1:2383:QuorumCnxManager<span class="variable">$Listener</span>@888] - Received connection request /127.0.0.1:53753</span><br><span class="line">2019-07-08 11:13:41,143 [myid:3] - WARN  [RecvWorker:2:QuorumCnxManager<span class="variable">$RecvWorker</span>@1176] - Connection broken <span class="keyword">for</span> id 2, my id = 3, error = </span><br><span class="line">java.net.SocketException: socket closed</span><br><span class="line">2019-07-08 11:13:41,145 [myid:3] - INFO  [WorkerReceiver[myid=3]:FastLeaderElection@679] - Notification: 2 (message format version), 2 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 2 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:13:41,413 [myid:3] - INFO  [WorkerReceiver[myid=3]:FastLeaderElection@679] - Notification: 2 (message format version), 3 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 1 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:13:41,525 [myid:3] - INFO  [WorkerReceiver[myid=3]:FastLeaderElection@679] - Notification: 2 (message format version), 3 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 2 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:13:41,726 [myid:3] - INFO  [QuorumPeer[myid=3](plain=/0:0:0:0:0:0:0:0:2183)(secure=disabled):QuorumPeer@1281] - LEADING</span><br></pre></td></tr></table></figure>
<h4 id="新服务器加入"><a href="#新服务器加入" class="headerlink" title="新服务器加入"></a>新服务器加入</h4><p><img src="../images/2019/ZooKeeper-Intro/server-join.png" alt=""></p>
<p>1、当服务器4启动时，初始处于<code>LOOKING</code>状态，<code>epoch</code>为1，<code>zxid</code>为0，向其他服务器发送投票给自己的通知；<br>2、其他服务器收到4发来的投票通知时，回复自己当前的状态以及投票的<code>Leader</code>；<br>3、服务器4收到其他服务器发来的状态和<code>Leader</code>，根据过半规则，服务器3有超过半数服务器的投票，因此服务器3仍然为<code>Leader</code>，服务器4切换<code>FOLLOWING</code>状态。<br>这里说明<code>epoch</code>（<code>zxid</code>）的目的是服务器4启动时，原有的ZK服务器<code>epoch</code>（<code>zxid</code>）很有可能已经<code>&gt;=1</code>，因此服务器4的<code>epoch</code>（<code>zxid</code>）必定小于等于其他服务器的<code>epoch</code>（<code>zxid</code>），因此服务器4不会成为<code>Leader</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># server 4</span></span><br><span class="line">2019-07-08 11:20:26,423 [myid:4] - INFO  [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2184)(secure=disabled):QuorumPeer@1193] - LOOKING</span><br><span class="line">2019-07-08 11:20:26,423 [myid:4] - INFO  [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2184)(secure=disabled):FastLeaderElection@885] - New election. My id =  4, proposed zxid=0x0</span><br><span class="line">2019-07-08 11:20:26,432 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@679] - Notification: 2 (message format version), 3 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 1 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:20:26,432 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@679] - Notification: 2 (message format version), 4 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 4 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:20:26,432 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@679] - Notification: 2 (message format version), 3 (n.leader), 0x0 (n.zxid), 0x1 (n.round), FOLLOWING (n.state), 1 (n.sid), 0x1 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:20:26,433 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@679] - Notification: 2 (message format version), 3 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 2 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:20:26,433 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@679] - Notification: 2 (message format version), 3 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 3 (n.sid), 0x0 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:20:26,433 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@679] - Notification: 2 (message format version), 3 (n.leader), 0x0 (n.zxid), 0x1 (n.round), FOLLOWING (n.state), 2 (n.sid), 0x1 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:20:26,434 [myid:4] - INFO  [WorkerReceiver[myid=4]:FastLeaderElection@679] - Notification: 2 (message format version), 3 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LEADING (n.state), 3 (n.sid), 0x1 (n.peerEPoch), LOOKING (my state)0 (n.config version)</span><br><span class="line">2019-07-08 11:20:26,434 [myid:4] - INFO  [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2184)(secure=disabled):QuorumPeer@1269] - FOLLOWING</span><br></pre></td></tr></table></figure>
<h4 id="Leader宕机"><a href="#Leader宕机" class="headerlink" title="Leader宕机"></a>Leader宕机</h4><p>当<code>Leader</code>发生宕机时，剩下的服务器仍然按照选举规则选出<code>Leader</code>，需要注意此时各服务器记录的<code>zxid</code>有可能不一致，选举的<code>Leader</code>将是<code>zxid</code>最大的那一台服务器。</p>
<h4 id="一致性保证"><a href="#一致性保证" class="headerlink" title="一致性保证"></a>一致性保证</h4><p><code>ZAB</code>协议保证了在领导选举的过程中，已经被<code>Commit</code>的数据不会丢失，未被<code>Commit</code>的数据对客户端不可见。<br>假设如下示例：服务器3发生宕机，同步的消息列表为<code>T1,C1,T2,C2,T3</code>（T表示客户端发起的操作事务消息，C表示<code>Leader</code>发出的提交消息），其中服务器1收到的消息与服务器3完全同步，服务器2收到的消息为<code>C1,T2,C2</code>，服务器4收到的消息为<code>T1,C1,T2</code>，服务器5收到的消息为<code>T1,C1,C2,T3</code>。需要注意：<br>由于<code>T3</code>没有对应的提交消息，意味着收到<code>T3</code>的服务器不会超过一半，当前只有服务器1和服务器2收到T3，因而<code>T3</code>不会被广播给其他服务器；<br>由于<code>T1</code>和<code>T2</code>都有对应的提交消息，因此整个集群中应当有超过一半的服务器收到过<code>T1</code>和<code>T2</code>。<br><img src="../images/2019/ZooKeeper-Intro/consistency.png" alt=""></p>
<h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><h3 id="集群管理"><a href="#集群管理" class="headerlink" title="集群管理"></a>集群管理</h3><p>在多台服务器组成的集群中，需要监控每台服务器的状态，一旦某台服务器宕机或有新的机器加入集群，集群需要感知到，从而执行相应的处理。通常的做法是有台主机器定时获取其他机器的心跳，或其他机器定时主动汇报自己的状态，这种方式存在一定的延时，并且主机器成为单点，一旦宕机便影响整个集群。<br>使用ZK可以方便的实现集群管理的功能：每个服务器启动时都向ZK提出创建临时节点的请求，并且添加父节点的事件监听器，当该服务器宕机时，它创建的临时节点也被ZK删除，删除时触发事件监听器，其他服务器便能得到通知。<br><img src="../images/2019/ZooKeeper-Intro/cluster-tree.png" alt=""></p>
<h3 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h3><p>多个客户端在同一个节点下添加临时顺序节点（节点名末尾实际上是10位10进制数），每个客户端对应着一个子节点，同时关注自己的前一个节点，如果没有前一个节点（即对应的节点编号是当前最小的），则认为获得了锁。<br>当客户端断开连接时，对应的临时节点自动被移除，关注该节点的下一个节点将收到通知，此时再判断是否存在前一个节点，不存在则认为获得了锁，存在则关注前一个节点，添加事件监听器。<br><img src="../images/2019/ZooKeeper-Intro/distributed-lock.png" alt=""></p>
<h3 id="分布式协调-通知"><a href="#分布式协调-通知" class="headerlink" title="分布式协调/通知"></a>分布式协调/通知</h3><p>利用事件监听器注册和异步通知机制实现对数据变更的实时处理。例如：不同系统都对ZK上同一个节点进行注册，监听节点的变化（包括节点本身内容及子节点），其中一个系统更新了节点，那么另一个系统能够收到通知，并作出相应处理。</p>
<h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><p>服务器启动时，在指定节点（假设为<code>Servers</code>节点）下注册临时子节点，客户端连接服务器时在<code>Servers</code>节点下根据一定的负载均衡规则计算得出一个服务器节点之后与其进行连接。</p>
<h2 id="ZK部署及使用"><a href="#ZK部署及使用" class="headerlink" title="ZK部署及使用"></a>ZK部署及使用</h2><p>从<code>https://mirrors.tuna.tsinghua.edu.cn/apache/zookeeper/current/</code>可下载ZK的最新版本。<br>ZK的安装和配置比较简单，可以配置成单机模式，也可以配置成集群模式。</p>
<h3 id="单机"><a href="#单机" class="headerlink" title="单机"></a>单机</h3><p>在<code>conf</code>目录下创建<code>zoo.cfg</code>（可拷贝<code>zoo_sample.cfg</code>文件后改名），添加以下配置：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 数据目录</span></span><br><span class="line">dataDir=E:/Work/zookeeper/zookeeper/data/</span><br><span class="line"><span class="comment"># log目录</span></span><br><span class="line">dataLogDir=D:/zookeeper/zookeeper/logs/</span><br><span class="line"><span class="comment"># 客户端连接端口</span></span><br><span class="line">clientPort=2181</span><br></pre></td></tr></table></figure></p>
<h3 id="伪集群"><a href="#伪集群" class="headerlink" title="伪集群"></a>伪集群</h3><p>所谓伪集群，是指在单台机器中启动多个ZK进程，并组成一个集群。<br>以3个ZK服务器为例，拷贝ZK安装包为三份：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">|--zk1  </span><br><span class="line">|--zk2  </span><br><span class="line">|--zk3</span><br></pre></td></tr></table></figure></p>
<p>修改<code>zk1/conf/zoo.cfg</code>配置为：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ZK中的时间单元（毫秒），所有时间以时间单元为基础进行整数倍配置</span></span><br><span class="line"><span class="comment"># The duration of a tick in milliseconds. This is the basic unit of time in ZooKeeper.</span></span><br><span class="line">tickTime=2000</span><br><span class="line"><span class="comment"># Follower启动时从Leader同步所有数据的时间限制（*tickTime）</span></span><br><span class="line"><span class="comment"># The maximum number of ticks that a follower will wait to initially synchronize with a leader.</span></span><br><span class="line">initLimit=10</span><br><span class="line"><span class="comment"># Follower等待Leader发过来消息的最长时间（*tickTime）</span></span><br><span class="line"><span class="comment"># The maximum number of ticks that a follower will wait for a message (including heartbeats) from the leader.</span></span><br><span class="line">syncLimit=5</span><br><span class="line"><span class="comment"># 数据目录</span></span><br><span class="line">dataDir=E:/Work/zookeeper/zk1/data/</span><br><span class="line"><span class="comment"># log目录</span></span><br><span class="line">dataLogDir=D:/zookeeper/zk1/logs/</span><br><span class="line"><span class="comment"># 客户端连接端口</span></span><br><span class="line">clientPort=2181</span><br><span class="line"><span class="comment"># 客户端连接数量限制</span></span><br><span class="line"><span class="comment">#maxClientCnxns=60</span></span><br><span class="line"><span class="comment"># 开启autopurge选项前先阅读：</span></span><br><span class="line"><span class="comment"># http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance</span></span><br><span class="line"><span class="comment"># 保留在dataDir下的快照数量</span></span><br><span class="line"><span class="comment">#autopurge.snapRetainCount=3</span></span><br><span class="line"><span class="comment"># 自动清理事务日志和快照时间间隔，0标识不开启</span></span><br><span class="line"><span class="comment">#autopurge.purgeInterval=1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 集群配置</span></span><br><span class="line">server.1=localhost:2281:2381</span><br><span class="line">server.2=localhost:2282:2382</span><br><span class="line">server.3=localhost:2283:2383</span><br><span class="line">server.4=localhost:2284:2384</span><br></pre></td></tr></table></figure></p>
<p>之后在<code>zk1/data</code>下新建一个<code>myid</code>文件，文件中写入服务器ID：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1</span><br></pre></td></tr></table></figure></p>
<p>服务器2和服务器3同上，调整<code>clientPort</code>、<code>dataDir</code>和<code>dataLogDir</code>配置以及<code>myid</code>文件中的服务器ID即可。</p>
<h3 id="5-3-集群"><a href="#5-3-集群" class="headerlink" title="5.3 集群"></a>5.3 集群</h3><p>集群配置与伪集群配置类似，只是集群配置中localhost需要修改为真实的服务器IP。<br>由于集群模式下，各个服务器部署在不同的机器上, 因此各个服务器的<code>conf/zoo.cfg</code>文件可以完全相同。</p>
<h3 id="5-4-启动-停止服务器"><a href="#5-4-启动-停止服务器" class="headerlink" title="5.4 启动/停止服务器"></a>5.4 启动/停止服务器</h3><p>bin目录下存放着ZK服务器常用的脚本：</p>
<ul>
<li><code>zkCleanup</code>：清理ZK历史数据，包括日志文件和快照数据文件；</li>
<li><code>zkCli</code>：ZK的一个简易客户端；</li>
<li><code>zkEnv</code>：设置ZK的环境变量；</li>
<li><code>zkServer</code>：ZK服务器的启动、停止、和重启脚本。</li>
</ul>
<p><code>Linux</code>：启动服务器执行<code>./zkServer.sh start</code>，停止服务器执行<code>./zkServer.sh stop</code>，重启服务器执行<code>./zkServer.sh restart</code>；<br><code>Windows</code>：启动服务器执行<code>zkServer.cmd</code>，停止服务器直接关闭控制台窗口或<code>Ctrl+C</code>。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ./zkServer.sh start</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: D:\zookeeper\zk5\conf\zoo.cfg</span><br><span class="line">Starting zookeeper ... STARTED</span><br><span class="line">$ ./zkServer.sh stop</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: D:\zookeeper\zk5\conf\zoo.cfg</span><br><span class="line">Stopping zookeeper ... STOPPED</span><br></pre></td></tr></table></figure></p>
<p>通过<code>./zkServer.sh status</code>可查询服务器状态：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ ./zkServer.sh status</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: D:\zookeeper\zk1\conf\zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost.</span><br><span class="line">Mode: follower</span><br><span class="line">$ <span class="built_in">cd</span> ../../zk2/bin &amp;&amp; ./zkServer.sh status</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: D:\zookeeper\zk2\conf\zoo.cfg</span><br><span class="line">Client port found: 2182. Client address: localhost.</span><br><span class="line">Mode: follower</span><br><span class="line">$ <span class="built_in">cd</span> ../../zk3/bin &amp;&amp; ./zkServer.sh status</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: D:\zookeeper\zk3\conf\zoo.cfg</span><br><span class="line">Client port found: 2183. Client address: localhost.</span><br><span class="line">Mode: leader</span><br></pre></td></tr></table></figure></p>
<h3 id="客户端命令"><a href="#客户端命令" class="headerlink" title="客户端命令"></a>客户端命令</h3><p>服务器开启成功后，通过<code>./zkCli.sh</code>（Windows下执行<code>zkCli.cmd</code>）启动客户端并与服务器连接。<br>默认连接<code>127.0.0.1:2181</code>，可在命令之后加上<code>-server ip:port</code>连接指定服务器。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">WATCHER::</span><br><span class="line"></span><br><span class="line">WatchedEvent state:SyncConnected <span class="built_in">type</span>:None path:null</span><br><span class="line">[zk: localhost:2181(CONNECTED) 0]</span><br></pre></td></tr></table></figure></p>
<p>输入<code>help</code>命令查看客户端支持的命令列表：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 0] <span class="built_in">help</span></span><br><span class="line">ZooKeeper -server host:port cmd args</span><br><span class="line">        addauth scheme auth</span><br><span class="line">        close</span><br><span class="line">        config [-c] [-w] [-s]</span><br><span class="line">        connect host:port</span><br><span class="line">        create [-s] [-e] [-c] [-t ttl] path [data] [acl]</span><br><span class="line">        delete [-v version] path</span><br><span class="line">        deleteall path</span><br><span class="line">        delquota [-n|-b] path</span><br><span class="line">        get [-s] [-w] path</span><br><span class="line">        getAcl [-s] path</span><br><span class="line">        <span class="built_in">history</span></span><br><span class="line">        listquota path</span><br><span class="line">        ls [-s] [-w] [-R] path</span><br><span class="line">        ls2 path [watch]</span><br><span class="line">        printwatches on|off</span><br><span class="line">        quit</span><br><span class="line">        reconfig [-s] [-v version] [[-file path] | [-members serverID=host:port1:port2;port3[,...]*]] | [-add serverId=host:port1:port2;port3[,...]]* [-remove serverId[,...]*]</span><br><span class="line">        redo cmdno</span><br><span class="line">        removewatches path [-c|-d|-a] [-l]</span><br><span class="line">        rmr path</span><br><span class="line">        <span class="built_in">set</span> [-s] [-v version] path data</span><br><span class="line">        setAcl [-s] [-v version] [-R] path acl</span><br><span class="line">        setquota -n|-b val path</span><br><span class="line">        <span class="built_in">stat</span> [-w] path</span><br><span class="line">        sync path</span><br><span class="line">Command not found: Command not found <span class="built_in">help</span></span><br></pre></td></tr></table></figure></p>
<h2 id="C-API应用"><a href="#C-API应用" class="headerlink" title="C API应用"></a>C API应用</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;WinSock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">"ws2_32.lib"</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USE_STATIC_LIB</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"zookeeper.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">"zookeeper.lib"</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">"hashtable.lib"</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SAFE_STR(x)     ((x == nullptr) ? <span class="meta-string">"nullptr"</span> : (const char*)x)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STATE_FORMAT    <span class="meta-string">"state:\n  czxid=%llu\n  mzxid=%llu\n  ctime=%llu\n  mtime=%llu\n\</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">  version=%u\n  cversion=%u\n  aversion=%u\n  ephemeralOwner=%llu\n  dataLength=%u\n\</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">  numChildren=%u\n  pzxid=%llu\n"</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">zktest_global_watcher</span><span class="params">(<span class="keyword">zhandle_t</span> *zh, <span class="keyword">int</span> type, <span class="keyword">int</span> state, </span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">void</span> *watcherCtx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"global_watcher_callback: type=%d state=%d path=%s\n"</span>, type, state, SAFE_STR(path));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">zktest_completion</span><span class="params">(<span class="keyword">int</span> rc, <span class="keyword">const</span> <span class="keyword">char</span> *value, <span class="keyword">const</span> <span class="keyword">void</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"completion_callback: rc=%d value=%s data=%s\n"</span>, rc, SAFE_STR(value), SAFE_STR(data));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">zktest_aexist_callback</span><span class="params">(<span class="keyword">int</span> rc, <span class="keyword">const</span> struct Stat *stat, </span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="keyword">void</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"completion_callback: rc=%d data=%s\n"</span>, rc, SAFE_STR(data));</span><br><span class="line">    <span class="keyword">if</span> (stat != <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(STATE_FORMAT, stat-&gt;czxid,stat-&gt;mzxid,stat-&gt;ctime,stat-&gt;mtime,stat-&gt;version,</span><br><span class="line">            stat-&gt;cversion,stat-&gt;aversion,stat-&gt;ephemeralOwner,stat-&gt;dataLength,</span><br><span class="line">            stat-&gt;numChildren,stat-&gt;pzxid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">zktest_adelete_callback</span><span class="params">(<span class="keyword">int</span> rc, <span class="keyword">const</span> <span class="keyword">void</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"aexist_callback: rc=%d\n"</span>, rc);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* szKey = <span class="string">"/key1"</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* szContext = <span class="string">"hello animal!"</span>;</span><br><span class="line">    <span class="keyword">int</span> nRet = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    zoo_set_debug_level(ZOO_LOG_LEVEL_DEBUG);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">zhandle_t</span>* pHandle = zookeeper_init(<span class="string">"127.0.0.1:2181"</span>, zktest_global_watcher, <span class="number">30000</span>, </span><br><span class="line">        <span class="literal">nullptr</span>, (<span class="keyword">void</span>*)<span class="string">"hello zookeeper!"</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (pHandle == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"zookeeper_init Create FAIL!"</span>);</span><br><span class="line">        <span class="keyword">goto</span> EXIT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create node</span></span><br><span class="line">    nRet = zoo_acreate(pHandle, szKey, szContext, <span class="built_in">strlen</span>(szContext), &amp;ZOO_OPEN_ACL_UNSAFE, </span><br><span class="line">        <span class="number">0</span>, zktest_completion, <span class="string">"completion_callback"</span>);</span><br><span class="line">    <span class="keyword">if</span> (nRet != ZOK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"zoo_acreate '%s' FAIL! nRet=%d\n"</span>, szKey, nRet);</span><br><span class="line">        <span class="keyword">goto</span> EXIT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check if exist</span></span><br><span class="line">    nRet = zoo_aexists(pHandle, szKey, <span class="number">1</span>, zktest_aexist_callback, <span class="string">"aexists"</span>);</span><br><span class="line">    <span class="keyword">if</span> (nRet != ZOK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"zoo_aget '%s' FAIL! nRet=%d\n"</span>, szKey, nRet);</span><br><span class="line">        <span class="keyword">goto</span> EXIT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// delete</span></span><br><span class="line">    <span class="comment">/*nRet = zoo_adelete(pHandle, szKey, -1, zktest_adelete_callback, "zoo_adelete");</span></span><br><span class="line"><span class="comment">    if (nRet != ZOK)</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">        std::cout &lt;&lt; "zoo_aget '" &lt;&lt; szKey &lt;&lt; "' FAIL! nRet=" &lt;&lt; nRet &lt;&lt; std::endl;</span></span><br><span class="line"><span class="comment">        goto EXIT;</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// wait 3s</span></span><br><span class="line">    ::Sleep(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// release handle</span></span><br><span class="line">    zookeeper_close(pHandle);</span><br><span class="line">    </span><br><span class="line">EXIT:</span><br><span class="line">    system(<span class="string">"pause"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">2019-07-08 22:13:05,058:14408(0x30bc):ZOO_INFO@log_env@1080: Client environment:zookeeper.version=zookeeper C client 3.5.5</span><br><span class="line">2019-07-08 22:13:05,064:14408(0x30bc):ZOO_INFO@log_env@1086: Client environment:host.name=&lt;not implemented&gt;</span><br><span class="line">2019-07-08 22:13:05,068:14408(0x30bc):ZOO_INFO@log_env@1095: Client environment:os.name=&lt;not implemented&gt;</span><br><span class="line">2019-07-08 22:13:05,073:14408(0x30bc):ZOO_INFO@log_env@1096: Client environment:os.arch=&lt;not implemented&gt;</span><br><span class="line">2019-07-08 22:13:05,077:14408(0x30bc):ZOO_INFO@log_env@1097: Client environment:os.version=&lt;not implemented&gt;</span><br><span class="line">2019-07-08 22:13:05,080:14408(0x30bc):ZOO_INFO@log_env@1103: Client environment:user.name=&lt;not implemented&gt;</span><br><span class="line">2019-07-08 22:13:05,085:14408(0x30bc):ZOO_INFO@log_env@1114: Client environment:user.home=&lt;not implemented&gt;</span><br><span class="line">2019-07-08 22:13:05,089:14408(0x30bc):ZOO_INFO@log_env@1121: Client environment:user.dir=E:\Work\Misc\ZKTest\Test</span><br><span class="line">2019-07-08 22:13:05,095:14408(0x30bc):ZOO_INFO@zookeeper_init_internal@1164: Initiating client connection, host=127.0.0.1:2181 sessionTimeout=30000 watcher=0118</span><br><span class="line">5230 sessionId=0 sessionPasswd=&lt;null&gt; context=011B2B9C flags=0</span><br><span class="line">2019-07-08 22:13:05,124:14408(0x30bc):ZOO_DEBUG@start_threads@221: starting threads...</span><br><span class="line">2019-07-08 22:13:05,134:14408(0x3898):ZOO_DEBUG@do_completion@471: started completion thread</span><br><span class="line">2019-07-08 22:13:05,134:14408(0x30bc):ZOO_DEBUG@zoo_acreate@3586: Sending request xid=0x5d234f71 <span class="keyword">for</span> path [/key1] to 0.0.0.0:0</span><br><span class="line">2019-07-08 22:13:05,144:14408(0x30bc):ZOO_DEBUG@zoo_awexists@3696: Sending request xid=0x5d234f72 <span class="keyword">for</span> path [/key1] to 0.0.0.0:0</span><br><span class="line">2019-07-08 22:13:05,134:14408(0x1224):ZOO_DEBUG@do_io@403: started IO thread</span><br><span class="line">2019-07-08 22:13:05,155:14408(0x1224):ZOO_DEBUG@get_next_server_in_reconfig@1310: [OLD] count=0 capacity=0 next=0 hasnext=0</span><br><span class="line">2019-07-08 22:13:05,166:14408(0x1224):ZOO_DEBUG@get_next_server_in_reconfig@1313: [NEW] count=1 capacity=16 next=0 hasnext=1</span><br><span class="line">2019-07-08 22:13:05,171:14408(0x1224):ZOO_DEBUG@get_next_server_in_reconfig@1322: Using next from NEW=127.0.0.1:2181</span><br><span class="line">2019-07-08 22:13:05,176:14408(0x1224):ZOO_DEBUG@zookeeper_connect@2210: [zk] connect()</span><br><span class="line"></span><br><span class="line">2019-07-08 22:13:05,184:14408(0x1224):ZOO_INFO@check_events@2451: initiated connection to server [127.0.0.1:2181]</span><br><span class="line">2019-07-08 22:13:05,211:14408(0x1224):ZOO_INFO@check_events@2503: session establishment complete on server [127.0.0.1:2181], sessionId=0x1000079413a000b, negotiated timeout=30000</span><br><span class="line">2019-07-08 22:13:05,219:14408(0x1224):ZOO_DEBUG@check_events@2509: Calling a watcher <span class="keyword">for</span> a ZOO_SESSION_EVENT and the state=ZOO_CONNECTED_STATE</span><br><span class="line">2019-07-08 22:13:05,225:14408(0x3898):ZOO_DEBUG@process_completions@2789: Calling a watcher <span class="keyword">for</span> node [], <span class="built_in">type</span> = -1 event=ZOO_SESSION_EVENT</span><br><span class="line">global_watcher_callback: <span class="built_in">type</span>=-1 state=3 path=</span><br><span class="line">2019-07-08 22:13:05,272:14408(0x1224):ZOO_DEBUG@zookeeper_process@2945: Queueing asynchronous response</span><br><span class="line">2019-07-08 22:13:05,277:14408(0x1224):ZOO_DEBUG@zookeeper_process@2945: Queueing asynchronous response</span><br><span class="line">2019-07-08 22:13:05,277:14408(0x3898):ZOO_DEBUG@deserialize_response@2710: Calling COMPLETION_STRING <span class="keyword">for</span> xid=0x5d234f71 failed=1, rc=-110</span><br><span class="line">completion_callback: rc=-110 value=nullptr data=completion_callback</span><br><span class="line">2019-07-08 22:13:05,290:14408(0x3898):ZOO_DEBUG@deserialize_response@2674: Calling COMPLETION_STAT <span class="keyword">for</span> xid=0x5d234f72 failed=0 rc=0</span><br><span class="line">completion_callback: rc=0 data=aexists</span><br><span class="line">state:</span><br><span class="line">  czxid=4294967323</span><br><span class="line">  mzxid=4294967323</span><br><span class="line">  ctime=1562594380609</span><br><span class="line">  mtime=1562594380609</span><br><span class="line">  version=0</span><br><span class="line">  cversion=0</span><br><span class="line">  aversion=0</span><br><span class="line">  ephemeralOwner=0</span><br><span class="line">  dataLength=13</span><br><span class="line">  numChildren=0</span><br><span class="line">  pzxid=4294967323</span><br><span class="line">2019-07-08 22:13:08,152:14408(0x1224):ZOO_DEBUG@do_io@458: IO thread terminated</span><br><span class="line">2019-07-08 22:13:08,155:14408(0x3898):ZOO_DEBUG@do_completion@481: completion thread terminated</span><br><span class="line">2019-07-08 22:13:08,160:14408(0x30bc):ZOO_INFO@zookeeper_close@3254: Closing zookeeper sessionId=0x1000079413a000b to [127.0.0.1:2181]</span><br></pre></td></tr></table></figure></p>
<p>通过官方客户端验证结果一致：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 10] get /key1</span><br><span class="line">hello animal!</span><br><span class="line">[zk: localhost:2181(CONNECTED) 11] get -s /key1</span><br><span class="line">hello animal!</span><br><span class="line">cZxid = 0x10000001b</span><br><span class="line">ctime = Mon Jul 08 21:59:40 CST 2019</span><br><span class="line">mZxid = 0x10000001b</span><br><span class="line">mtime = Mon Jul 08 21:59:40 CST 2019</span><br><span class="line">pZxid = 0x10000001b</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 13</span><br><span class="line">numChildren = 0</span><br></pre></td></tr></table></figure></p>
<h2 id="一些问题"><a href="#一些问题" class="headerlink" title="一些问题"></a>一些问题</h2><h3 id="新的Leader选出时同步方式"><a href="#新的Leader选出时同步方式" class="headerlink" title="新的Leader选出时同步方式"></a>新的Leader选出时同步方式</h3><p><strong><code>SNAP</code>-全量同步</strong><br>条件：<code>peerLastZxid&lt;minCommittedLog</code><br>二者数据差异太大，<code>Follower</code>数据过于陈旧，<code>Leader</code>发送快照<code>SNAP</code>指令给<code>Follower</code>全量同步数据。<br><strong><code>DIFF</code>-增量同步</strong><br>条件：<code>minCommittedLog&lt;=peerLastZxid&lt;=maxCommittedLog</code><br>二者数据差异不大，<code>Follower</code>上有一些<code>Leader</code>上已经提交的提议未同步，此时需要增量提交。<br><strong><code>TRUNC</code>-仅回滚同步</strong><br>条件：<code>peerLastZxid&gt;minCommittedLog</code><br>证明<code>Follower</code>上有些提议并未在<code>Leader</code>上提交，<code>Follower</code>需要回滚到<code>zxid</code>为<code>minCommittedLog</code>对应的事务操作。<br><strong><code>TRUNC+DIFF</code>-回滚+增量同步</strong><br>条件：<code>minCommittedLog&lt;=peerLastZxid&lt;=maxCommittedLog</code>且原<code>Leader</code>已经将事务<code>Tx</code>提交到本地事务日志中，但没有成功发起提议就宕机了；之后集群重新选举出新<code>Leader</code>，新<code>Leader</code>收到了若干新的更新操作并发起了提议，之后原<code>Leader</code>重新加入到集群中。<br>此时原<code>Leader</code>和新<code>Leader</code>都有对方未提交的事务，原<code>Leader</code>加入集群后需要先回滚<code>Tx</code>之后同步新<code>Leader</code>的数据。</p>
<h3 id="丢包问题"><a href="#丢包问题" class="headerlink" title="丢包问题"></a>丢包问题</h3><p><strong>提议消息</strong>：<code>Leader</code>会定时向<code>Follower</code>发送<code>PING</code>消息，如果<code>Leader</code>发送出去的提议消息超过一定时间（<code>tick * syncLimit</code>，默认10秒）没有收到<code>Follower</code>的<code>ACK</code>，会导致<code>PING</code>失败，最终<code>Leader</code>会断开与<code>Follower</code>的连接。因为连接断开，<code>Follower</code>会退出<code>FOLLOWING</code>状态（收包出现异常），重新进入<code>LOOKING</code>状态。<br><strong>提交消息</strong>：此时客户端连接该<code>Follower</code>所看到的数据不是实时的。下一次收到提交消息时，会终止<code>Follower</code>进程，因为收到的提交消息中的<code>zxid</code>与上一次待提交的提议对应的<code>zxid</code>不匹配。</p>
<h3 id="动态扩容问题"><a href="#动态扩容问题" class="headerlink" title="动态扩容问题"></a>动态扩容问题</h3><p>逐个服务器重启：每次操作一台服务器，更新配置后重启，优先操作新的服务器。<br>整体重启：停止所有服务器，更新配置后全部启动。</p>
<h3 id="奇数服务器数量问题"><a href="#奇数服务器数量问题" class="headerlink" title="奇数服务器数量问题"></a>奇数服务器数量问题</h3><p>任意数量台服务器都可以构建为一个ZK集群。但考虑如下情况：</p>
<ul>
<li>服务器数量为偶数（假设为<code>2n</code>），过半为<code>n+1</code>，允许宕掉的服务器数量为<code>n-1</code>  </li>
<li>服务器数量为奇数（假设为<code>2n-1</code>），过半为<code>n</code>，允许宕掉的服务器数量为<code>n-1</code>  </li>
</ul>
<p>配置为奇数数量相比于偶数数量少占用一台服务器，因此奇数数量服务器配置更有优势。  </p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p>[1] <a href="https://www.ibm.com/developerworks/cn/opensource/os-cn-zookeeper/" target="_blank" rel="noopener">分布式服务框架 Zookeeper — 管理分布式环境中的数据</a><br>[2] <a href="https://www.cnblogs.com/leesf456/p/6012777.html" target="_blank" rel="noopener">【分布式】Zookeeper与Paxos</a><br>[3] <a href="http://www.jasongj.com/zookeeper/distributedlock/" target="_blank" rel="noopener">深入浅出Zookeeper（二） 基于Zookeeper的分布式锁与领导选举</a><br>[4] <a href="http://www.jasongj.com/zookeeper/fastleaderelection/" target="_blank" rel="noopener">深入浅出Zookeeper（一） Zookeeper架构及FastLeaderElection机制</a><br>[5] <a href="https://www.cnblogs.com/ASPNET2008/p/6421571.html" target="_blank" rel="noopener">理解zookeeper选举机制</a><br>[6] <a href="https://www.jianshu.com/p/c2ced54736aa" target="_blank" rel="noopener">Zookeeper选举算法原理（摘选）</a><br>[7] <a href="https://www.cnblogs.com/haippy/archive/2013/02/21/2919365.html" target="_blank" rel="noopener">Zookeeper C API 指南一(准备工作)</a><br>[8] <a href="http://sel-fish.net/2017/06/12/zk-data-sync" target="_blank" rel="noopener">ZooKeeper - Data Sync</a>    </p>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a  href="/2019/ZooKeeper-Intro.html">ZooKeeper服务框架介绍</a></p>
        <p><span>文章作者:</span><a  href="/" title="访问 lfeng 的个人博客">lfeng</a></p>
        <p><span>发布时间:</span>2019年07月11日 - 23时09分</p>
        <p><span>最后更新:</span>2019年07月12日 - 00时09分</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2019/ZooKeeper-Intro.html" title="ZooKeeper服务框架介绍">https://blog.lfengs.com/2019/ZooKeeper-Intro.html</a>
            <span class="copy-path" data-clipboard-text="原文: https://blog.lfengs.com/2019/ZooKeeper-Intro.html　　作者: lfeng" title=""></span>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)" target = "_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



<nav id="article-nav">
  
  
    <a  href="/2019/Fix-remote-desktop-authentication-error.html" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">解决Win7远程桌面连接发生身份验证错误问题</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>


  
</article>

    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#描述"><span class="toc-number">1.</span> <span class="toc-text">描述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#特性"><span class="toc-number">1.1.</span> <span class="toc-text">特性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据模型"><span class="toc-number">2.</span> <span class="toc-text">数据模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#节点类型"><span class="toc-number">2.1.</span> <span class="toc-text">节点类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#节点属性"><span class="toc-number">2.2.</span> <span class="toc-text">节点属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#事件监听器（Watch）"><span class="toc-number">2.3.</span> <span class="toc-text">事件监听器（Watch）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#访问控制（ACL）"><span class="toc-number">2.4.</span> <span class="toc-text">访问控制（ACL）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#服务器集群"><span class="toc-number">3.</span> <span class="toc-text">服务器集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#角色"><span class="toc-number">3.1.</span> <span class="toc-text">角色</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#原子消息广播协议（Zookeeper-Atomic-Broadcast）"><span class="toc-number">3.2.</span> <span class="toc-text">原子消息广播协议（Zookeeper Atomic Broadcast）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务器状态"><span class="toc-number">3.3.</span> <span class="toc-text">服务器状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#会话"><span class="toc-number">3.4.</span> <span class="toc-text">会话</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#读写操作"><span class="toc-number">3.5.</span> <span class="toc-text">读写操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#读操作"><span class="toc-number">3.5.1.</span> <span class="toc-text">读操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#写操作"><span class="toc-number">3.5.2.</span> <span class="toc-text">写操作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#领导选举"><span class="toc-number">3.6.</span> <span class="toc-text">领导选举</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#投票数据结构"><span class="toc-number">3.6.1.</span> <span class="toc-text">投票数据结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#投票流程"><span class="toc-number">3.6.2.</span> <span class="toc-text">投票流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#领导选举场景"><span class="toc-number">3.7.</span> <span class="toc-text">领导选举场景</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#启动时"><span class="toc-number">3.7.1.</span> <span class="toc-text">启动时</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#新服务器加入"><span class="toc-number">3.7.2.</span> <span class="toc-text">新服务器加入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Leader宕机"><span class="toc-number">3.7.3.</span> <span class="toc-text">Leader宕机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#一致性保证"><span class="toc-number">3.7.4.</span> <span class="toc-text">一致性保证</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#应用场景"><span class="toc-number">4.</span> <span class="toc-text">应用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#集群管理"><span class="toc-number">4.1.</span> <span class="toc-text">集群管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分布式锁"><span class="toc-number">4.2.</span> <span class="toc-text">分布式锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分布式协调-通知"><span class="toc-number">4.3.</span> <span class="toc-text">分布式协调/通知</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#负载均衡"><span class="toc-number">4.4.</span> <span class="toc-text">负载均衡</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ZK部署及使用"><span class="toc-number">5.</span> <span class="toc-text">ZK部署及使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#单机"><span class="toc-number">5.1.</span> <span class="toc-text">单机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#伪集群"><span class="toc-number">5.2.</span> <span class="toc-text">伪集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-集群"><span class="toc-number">5.3.</span> <span class="toc-text">5.3 集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-启动-停止服务器"><span class="toc-number">5.4.</span> <span class="toc-text">5.4 启动/停止服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#客户端命令"><span class="toc-number">5.5.</span> <span class="toc-text">客户端命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#C-API应用"><span class="toc-number">6.</span> <span class="toc-text">C API应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一些问题"><span class="toc-number">7.</span> <span class="toc-text">一些问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#新的Leader选出时同步方式"><span class="toc-number">7.1.</span> <span class="toc-text">新的Leader选出时同步方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#丢包问题"><span class="toc-number">7.2.</span> <span class="toc-text">丢包问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#动态扩容问题"><span class="toc-number">7.3.</span> <span class="toc-text">动态扩容问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#奇数服务器数量问题"><span class="toc-number">7.4.</span> <span class="toc-text">奇数服务器数量问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考链接"><span class="toc-number">8.</span> <span class="toc-text">参考链接</span></a></li></ol>
</div>
<style>
    .left-col .switch-btn {
        display: none;
    }
    .left-col .switch-area {
        display: none;
    }
</style>
<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>

<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";
    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }
    $("#tocButton").click(function() {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
            $(".switch-btn, .switch-area").fadeOut(300);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
            $(".switch-btn, .switch-area").fadeIn(500);
        }
    })
    if ($(".toc").length < 1) {
        $("#toc, #tocButton").hide();
        $(".switch-btn, .switch-area").show();
    }
</script>






    



    <div class="scroll" id="post-nav-button">
        
            <a  href="/" title="回到主页"><i class="fa fa-home"></i></a>
        
        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>
        
            <a  href="/2019/Fix-remote-desktop-authentication-error.html" title="下一篇: 解决Win7远程桌面连接发生身份验证错误问题">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>
    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/ZooKeeper-Intro.html">ZooKeeper服务框架介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/Fix-remote-desktop-authentication-error.html">解决Win7远程桌面连接发生身份验证错误问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/Building-openssl-with-curl-in-Windows.html">Windows编译curl和openssl</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/ReanameTool-User-Manual.html">重命名用户手册</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/SVN-change-filename-to-lowercase-recursively-in-Windows.html">SVN递归将文件名改为小写</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/Set-up-Master-Slave-Replication-in-MySQL.html">MySQL Master/Slave同步配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/RabbitMQ-Installation-Guide-on-Windows.html">Windows下安装RabbitMQ</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/One-way-to-resolve-HTTP-send-request-return-12029.html">HTTPSendRequest失败返回12029的一个解决方案</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/Create-and-use-dynamic-library-in-Ubuntu.html">Ubuntu环境下创建和使用动态库</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/Add-protobuf-lite-for-cocos2dx.html">为cocos2dx添加protobuf-lite支持</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/Analyze-CLR-application-dump-with-windbg.html">使用Windbg简单分析托管程序dump</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/Building-personal-blog-with-github-and-hexo.html">使用Github和hexo搭建个人博客（多图）</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/Simple-introduction-of-behaviac.html">Behaviac简单介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/Building-cocos2dx-3_2-project-with-VS2015.html">使用VS2015编译cocos2dx-3.2项目</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/TS3-create-read-write-data-with-json.html">Trigger第三篇：创建、读取和写入json文件</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/TS2-map-layout.html">Trigger第二篇：关卡布局</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/TS1-resources-analyze.html">Trigger第一篇：简介以及资源分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/New-beginning.html">新的开始</a></li></ul>
    
<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>

    <script>
        $(".post-list").addClass("toc-article");
        // $(".post-list-item a").attr("target","_blank");
        $("#post-nav-button > a:nth-child(2)").click(function() {
            $(".fa-bars, .fa-times").toggle();
            $(".post-list").toggle(300);
            if ($(".toc").length > 0) {
                $("#toc, #tocButton").toggle(200, function() {
                    if ($(".switch-area").is(":visible")) {
                        $("#toc, .switch-btn, .switch-area").toggle();
                        $("#tocButton").attr("value", valueHide);
                        }
                    })
            }
            else {
                $(".switch-btn, .switch-area").fadeToggle(300);
            }
        })
    </script>




    <script>
        
    </script>

</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2019 lfeng
            </div>
            <!-- <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo &nbsp;&nbsp;</a><a href="https://github.com/maochunguang" target="_blank">Blog</a> by tommy
            </div> -->
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" >访客数: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit">阅读量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
    
<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>

<script src="/js/main.js"></script>

    <script>
        $(document).ready(function() {
            var backgroundnum = 1;
            var backgroundimg = "url(/img/background/bg-" + backgroundnum +".jpg)";
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>






<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(
            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>


  </div>
</body>
</html>